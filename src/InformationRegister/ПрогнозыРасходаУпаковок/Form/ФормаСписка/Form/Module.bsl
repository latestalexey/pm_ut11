////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	НормативноеКоличествоЗапаса = "Все";
	
	УстановитьОтборы();
КонецПроцедуры

&НаСервере
Процедура ПриЗагрузкеДанныхИзНастроекНаСервере(Настройки)
	УстановитьОтборы();
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ЭЛЕМЕНТОВ ШАПКИ ФОРМЫ

&НаКлиенте
Процедура СкладПриИзменении(Элемент)
	УстановитьОтборы();
КонецПроцедуры

&НаКлиенте
Процедура ПомещениеПриИзменении(Элемент)
	УстановитьОтборы();
КонецПроцедуры

&НаКлиенте
Процедура НормативноеКоличествоЗапаса1ПриИзменении(Элемент)
	УстановитьОтборы();
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ЭЛЕМЕНТОВ ШАПКИ ФОРМЫ

&НаКлиенте
Процедура ИспользоватьРекомендуемоеНормативноеКоличествоЗапаса(Команда)
	МассивЗаписей = Элементы.Список.ВыделенныеСтроки;
	
	Если МассивЗаписей.Количество() = 0 Тогда
		ТекстСообщения = НСтр("ru = 'Выделите строки, в которых нужно установить использование рекомендуемого нормативного запаса.'");
		Предупреждение(ТекстСообщения);
		Возврат;
	Иначе
		ТекстВопроса = НСтр("ru = 'При выполнении операции в выделенных строках будет очищено нормативное количество запаса, назначенное вручную. Продолжить?'");
		Ответ = Вопрос(ТекстВопроса,РежимДиалогаВопрос.ДаНет);
		
		Если Ответ <> КодВозвратаДиалога.Да Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	ИспользоватьРекомендуемоеНормативноеКоличествоЗапасаСервер(МассивЗаписей);	
		
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

////////////////////////////////////////////////////////////////////////////////
// При изменении реквизитов

&НаСервере
Процедура УстановитьОтборы()
	ТолькоЗначенияНазначенныеВручную = (НормативноеКоличествоЗапаса = "НазначенныеВручную");
	
	ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбора(Список.Отбор, "Помещение", Помещение, ВидСравненияКомпоновкиДанных.Равно,, Истина, РежимОтображенияЭлементаНастройкиКомпоновкиДанных.Недоступный);
	ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбора(Список.Отбор, "Склад", Склад, ВидСравненияКомпоновкиДанных.Равно,, Истина, РежимОтображенияЭлементаНастройкиКомпоновкиДанных.Недоступный);
	ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбора(Список.Отбор, "НазначеноПользователем", ТолькоЗначенияНазначенныеВручную, ВидСравненияКомпоновкиДанных.Равно,, ТолькоЗначенияНазначенныеВручную, РежимОтображенияЭлементаНастройкиКомпоновкиДанных.Недоступный);
	
	УстановитьПараметрыФункциональныхОпцийФормы(Новый Структура("Склад", Склад));
	
	Если СкладыСервер.ИспользоватьПодпиткуЗонБыстрогоОтбора(Склад, Помещение) Тогда
		Элементы.ДекорацияИспользованиеПодпитки.Заголовок = "";
		Элементы.Список.ИзменятьСоставСтрок = Истина;
	ИначеЕсли ЗначениеЗаполнено(Склад)
		И Не СкладыСервер.ИспользоватьСкладскиеПомещения(Склад)
		Или ЗначениеЗаполнено(Помещение) Тогда
		
		ТекстЗаголовка = НСтр("ru = 'На складе ""%Склад%"" не используется подпитка зон быстрого отбора, поэтому прогнозирование расхода упаковок не ведется.'");
		ТекстЗаголовка = СтрЗаменить(ТекстЗаголовка, "%Склад%", СкладыСервер.ПолучитьПредставлениеСклада(Склад, Помещение));
		
		Элементы.ДекорацияИспользованиеПодпитки.Заголовок = ТекстЗаголовка;
		Элементы.Список.ИзменятьСоставСтрок = Ложь;
	Иначе
		Элементы.ДекорацияИспользованиеПодпитки.Заголовок = "";
		Элементы.Список.ИзменятьСоставСтрок = Ложь;
	КонецЕсли;
		
КонецПроцедуры

&НаСервере
Процедура ИспользоватьРекомендуемоеНормативноеКоличествоЗапасаСервер(МассивЗаписей)
	
	Для Каждого СтрМас Из МассивЗаписей Цикл
		Если ТипЗнч(СтрМас) <> Тип("РегистрСведенийКлючЗаписи.ПрогнозыРасходаУпаковок")
			Тогда
			Продолжить;
		КонецЕсли;
		
		Набор = РегистрыСведений.ПрогнозыРасходаУпаковок.СоздатьНаборЗаписей();
		Набор.Отбор.Склад.Установить(СтрМас.Склад);
		Набор.Отбор.Помещение.Установить(СтрМас.Помещение);
		Набор.Отбор.Номенклатура.Установить(СтрМас.Номенклатура);
		Набор.Отбор.Характеристика.Установить(СтрМас.Характеристика);
		Набор.Отбор.Серия.Установить(СтрМас.Серия);
		Набор.Отбор.Упаковка.Установить(СтрМас.Упаковка);
		
		Набор.Прочитать();
		
		Если Набор.Количество() > 0 Тогда
			Если Не Набор[0].НазначеноПользователем Тогда
				Продолжить;
			КонецЕсли;
		Иначе
			Продолжить;
		КонецЕсли;
		
		НоваяСтрока = Набор[0];
		НоваяСтрока.НазначеноПользователем      = Ложь;
		НоваяСтрока.НормативноеКоличествоЗапаса = 0;
		
		Набор.Записать();
	КонецЦикла;
	
	Элементы.Список.Обновить();
КонецПроцедуры
