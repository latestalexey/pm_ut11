////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

// Функция возвращает таблицу реквизитов, зависимых от хозяйственной операции документа.
//
Функция ПолучитьМассивыРеквизитов(ХозяйственнаяОперация, МассивВсехРеквизитов, МассивРеквизитовОперации) Экспорт
	
	МассивВсехРеквизитов = Новый Массив;
	МассивВсехРеквизитов.Добавить("ГрафикОплаты");
	МассивВсехРеквизитов.Добавить("ФормаОплаты");
	МассивВсехРеквизитов.Добавить("Товары.ПроцентРучнойСкидки");
	МассивВсехРеквизитов.Добавить("Товары.СуммаРучнойСкидки");
	МассивВсехРеквизитов.Добавить("Товары.ПроцентАвтоматическойСкидки");
	МассивВсехРеквизитов.Добавить("Товары.СуммаАвтоматическойСкидки");
	
	МассивРеквизитовОперации = Новый Массив;
	Если ХозяйственнаяОперация <> Перечисления.ХозяйственныеОперации.ПередачаНаКомиссию Тогда
		МассивРеквизитовОперации.Добавить("ГрафикОплаты");
		МассивРеквизитовОперации.Добавить("ФормаОплаты");
		МассивРеквизитовОперации.Добавить("Товары.ПроцентРучнойСкидки");
		МассивРеквизитовОперации.Добавить("Товары.СуммаРучнойСкидки");
		МассивРеквизитовОперации.Добавить("Товары.ПроцентАвтоматическойСкидки");
		МассивРеквизитовОперации.Добавить("Товары.СуммаАвтоматическойСкидки");
	КонецЕсли;
	
КонецФункции // ПолучитьМассивыРеквизитов()

Функция ПолучитьДанныеПечати(знач МассивДокументов, знач МассивИменМакетов) Экспорт
	
	Возврат Новый Структура("Данные,Макеты",
				ПолучитьДанныеОбъектаПоМакетам(МассивДокументов, МассивИменМакетов),
				ПолучитьМакетыИОписанияСекций(МассивИменМакетов));
	
КонецФункции // ПолучитьДанныеПечати()

Функция ПолучитьОписаниеОбластейКоммерческоеПредложение()

	Секции = Новый Структура;
	
	УправлениеПечатью.ДобавитьОписаниеОбласти(Секции, "Заголовок",              "Общая");
	УправлениеПечатью.ДобавитьОписаниеОбласти(Секции, "ШапкаТаблицаТовары",     "СтрокаТаблицы");
	УправлениеПечатью.ДобавитьОписаниеОбласти(Секции, "СтрокаТаблицаТовары",    "СтрокаТаблицы");
	УправлениеПечатью.ДобавитьОписаниеОбласти(Секции, "ПодвалТаблицаТовары",    "СтрокаТаблицы");
	УправлениеПечатью.ДобавитьОписаниеОбласти(Секции, "Подвал",                 "Общая");
	
	Возврат Секции;

КонецФункции // ПолучитьОписаниеОбластейКоммерческоеПредложение()

Функция ПолучитьДанныеКоммерческоеПредложение(СсылкаНаОбъект)
	
	Если ЗначениеЗаполнено(СсылкаНаОбъект.ДокументОснование) Тогда
		ДанныеОбъекта = Новый Структура;
		ДанныеОбъекта.Вставить("Номер",          СсылкаНаОбъект.ДокументОснование.Номер);
        ДанныеОбъекта.Вставить("Дата",          Формат(СсылкаНаОбъект.ДокументОснование.Дата,"ДЛФ=ДД"));
		ДанныеОбъекта.Вставить("ПолнНаименованиеКонтрагента",          СсылкаНаОбъект.ДокументОснование.Контрагент);
	Иначе
		Сообщить("Не выбран документ основание");
		ДанныеОбъекта = Новый Структура;
		ДанныеОбъекта.Вставить("Номер",          "");
        ДанныеОбъекта.Вставить("Дата",          "");
		ДанныеОбъекта.Вставить("ПолнНаименованиеКонтрагента",          "");

	КонецЕсли;	
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	АК_Договор_СпецификацияТовары.НомерСтроки,
	                      |	АК_Договор_СпецификацияТовары.Номенклатура,
	                      |	АК_Договор_СпецификацияТовары.Номенклатура.Код,
	                      |	АК_Договор_СпецификацияТовары.Номенклатура.Артикул,
	                      |	АК_Договор_СпецификацияТовары.Номенклатура.Описание,
	                      |	АК_Договор_СпецификацияТовары.Количество,
	                      |	АК_Договор_СпецификацияТовары.Цена,
	                      |	АК_Договор_СпецификацияТовары.Сумма,
	                      |	АК_Договор_СпецификацияТовары.СтавкаНДС
	                      |ИЗ
	                      |	Документ.АК_Договор_Спецификация.Товары КАК АК_Договор_СпецификацияТовары
	                      |ГДЕ
	                      |	АК_Договор_СпецификацияТовары.Ссылка = &Ссылка
	                      |	И АК_Договор_СпецификацияТовары.Активность = ИСТИНА");
	
	Запрос.УстановитьПараметр("Ссылка",СсылкаНаОбъект);      
	ДанныеОбъекта.Вставить("Товары", Новый Массив);
	Выборка = Запрос.Выполнить().Выбрать();
	НомерСТроки=0;
	СтруктураТовары = Новый Структура;
	Пока Выборка.Следующий() Цикл
		СтруктураТовары = Новый Структура;
		НомерСтроки=НомерСтроки+1;
        СтруктураТовары.Вставить("НомерСтроки",НомерСтроки);
		СтруктураТовары.Вставить("Номенклатура",Выборка.Номенклатура);
        СтруктураТовары.Вставить("Код",Выборка.НоменклатураКод);
		СтруктураТовары.Вставить("ЕдИзмерения",Выборка.Номенклатура.ЕдиницаИзмерения);
        СтруктураТовары.Вставить("Артикул",Выборка.НоменклатураАртикул);
        СтруктураТовары.Вставить("Количество",Выборка.Количество);
		СтруктураТовары.Вставить("Описание",Выборка.НоменклатураОписание);
        СтруктураТовары.Вставить("Цена",Выборка.Цена);
        СтруктураТовары.Вставить("Сумма",Выборка.Сумма);
        СтруктураТовары.Вставить("СтавкаНДС",Выборка.СтавкаНДС);
		ДанныеОбъекта.товары.Добавить(СтруктураТовары);
	КонецЦикла;	
	ТЗСумма=Запрос.Выполнить().Выгрузить();
	ДанныеОбъекта.Вставить("ВсегоКоличество", ТЗСумма.Итог("Количество"));
	ДанныеОбъекта.Вставить("ВсегоСумма", ТЗСумма.Итог("Сумма"));
	ВалютаУпр = ЗначениеНастроекПовтИсп.ПолучитьЗначениеКонстанты("ВалютаУправленческогоУчета");
	ДанныеОбъекта.Вставить("СуммаПрописью",          ФормированиеПечатныхФорм.СформироватьСуммуПрописью(ТЗСумма.Итог("Сумма"), ВалютаУпр));
	Возврат ДанныеОбъекта;

КонецФункции // ПолучитьДанныеКоммерческоеПредложение()

Функция ПолучитьДанныеОбъектаПоМакетам(знач МассивДокументов, знач МассивИменМакетов) Экспорт
	
	ДанныеПоВсемОбъектам = Новый Соответствие;
	
	Для Каждого ОбъектСсылка Из МассивДокументов Цикл
		ДанныеОбъектаПоМакетам = Новый Структура;
		Для Каждого ИмяМакета Из МассивИменМакетов Цикл
			ДанныеОбъекта = Неопределено;
			Если ИмяМакета = "АК_DOC_Спецификация" Тогда
				ДанныеОбъекта = ПолучитьДанныеКоммерческоеПредложение(ОбъектСсылка);
			ИначеЕсли ИмяМакета = "АК_DOC_Монтаж" Тогда
				ДанныеОбъекта = ПолучитьДанныеКоммерческоеПредложение(ОбъектСсылка);
			КонецЕсли;
			Если ДанныеОбъекта <> Неопределено Тогда
				ДанныеОбъектаПоМакетам.Вставить(ИмяМакета, ДанныеОбъекта);
			КонецЕсли;
		КонецЦикла;
		ДанныеПоВсемОбъектам.Вставить(ОбъектСсылка, ДанныеОбъектаПоМакетам);
	КонецЦикла;
	

	Возврат ДанныеПоВсемОбъектам;
	
КонецФункции // ПолучитьДанныеОбъектаПоМакетам()

Функция ПолучитьМакетыИОписанияСекций(знач МассивИменМакетов) Экспорт
	
	ОписаниеСекций = Новый Структура;
	ДвоичныеДанныеМакетов = Новый Структура;
	
	Для Каждого ИмяМакета Из МассивИменМакетов Цикл
		
		Макет = Неопределено;
		ОписаниеСекцийМакета = Неопределено;
		
		Если ИмяМакета = "АК_DOC_Спецификация" Тогда
			ОписаниеСекцийМакета = ПолучитьОписаниеОбластейКоммерческоеПредложение();
			Макет = УправлениеПечатью.ПолучитьМакет("Документ.АК_Договор_Спецификация.АК_DOC_Спецификация");
		ИначеЕсли ИмяМакета = "АК_DOC_Монтаж" Тогда
			ОписаниеСекцийМакета = ПолучитьОписаниеОбластейКоммерческоеПредложение();
			Макет = УправлениеПечатью.ПолучитьМакет("Документ.АК_Договор_Спецификация.АК_DOC_Монтаж");
		КонецЕсли;
		
		Если ОписаниеСекцийМакета <> Неопределено И Макет <> Неопределено Тогда
			
			ОписаниеСекций.Вставить(ИмяМакета, ОписаниеСекцийМакета);
			ДвоичныеДанныеМакетов.Вставить(ИмяМакета, Макет);
			
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Новый Структура(
						"ОписаниеСекций,ДвоичныеДанныеМакетов",
						ОписаниеСекций,
						ДвоичныеДанныеМакетов
					);
	
КонецФункции // ПолучитьМакетыИОписанияСекций()

 // Сформировать печатные формы объектов
//
// ВХОДЯЩИЕ:
//   ИменаМакетов    - Строка    - Имена макетов, перечисленные через запятую
//   МассивОбъектов  - Массив    - Массив ссылок на объекты которые нужно распечатать
//   ПараметрыПечати - Структура - Структура дополнительных параметров печати
//
// ИСХОДЯЩИЕ:
//   КоллекцияПечатныхФорм - Таблица значений - Сформированные табличные документы
//   ПараметрыВывода       - Структура        - Параметры сформированных табличных документов
//
Процедура Печать(МассивОбъектов, ПараметрыПечати, КоллекцияПечатныхФорм, ОбъектыПечати, ПараметрыВывода) Экспорт
	
	ПараметрыВывода.ДоступнаПечатьПоКомплектно = Истина;
	
	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "АК_Спецификация") Тогда
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(КоллекцияПечатныхФорм, "АК_Спецификация", "Спецификация", СформироватьПечатнуюФормуСпецификация(МассивОбъектов, ОбъектыПечати));
	КонецЕсли;
 	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "АК_ЗаявкаНаМонтаж") Тогда
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(КоллекцияПечатныхФорм, "АК_ЗаявкаНаМонтаж", "Заявка на монтаж", СформироватьПечатнуюФормуЗаявка(МассивОбъектов, ОбъектыПечати));
	КонецЕсли;

КонецПроцедуры // Печать()


Функция СформироватьПечатнуюФормуСпецификация(МассивОбъектов, ОбъектыПечати)
	Для Каждого СсылкаНаОбъект Из МассивОбъектов Цикл

	УстановитьПривилегированныйРежим(Истина);

	ТабличныйДокумент = Новый ТабличныйДокумент;
	ТабличныйДокумент.КоличествоЭкземпляров=1;
	
	ВалютаУпр = ЗначениеНастроекПовтИсп.ПолучитьЗначениеКонстанты("ВалютаУправленческогоУчета");
	Если ЗначениеЗаполнено(СсылкаНаОбъект.ДокументОснование) Тогда
		Номер = СсылкаНаОбъект.ДокументОснование.Номер;
        Дата=Формат(СсылкаНаОбъект.ДокументОснование.Дата,"ДЛФ=ДД");
		ПолнНаименованиеКонтрагента=СсылкаНаОбъект.ДокументОснование.Контрагент;
		ФизЛицоНадпись=СократитьФИО(СсылкаНаОбъект.ДокументОснование.ФизЛицо.Наименование);
		ДолжностьФизЛицо =СсылкаНаОбъект.ДокументОснование.ФизЛицо.АК_Должность.Наименование; 
	Иначе
		Сообщить("Не выбран документ основание");
		Номер="";
		Дата="";
        ПолнНаименованиеКонтрагента="";
		ФизЛицоНадпись="";
		ДолжностьФизЛицо ="";

 	КонецЕсли;	
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	АК_Договор_СпецификацияТовары.НомерСтроки,
	                      |	АК_Договор_СпецификацияТовары.Номенклатура,
	                      |	АК_Договор_СпецификацияТовары.Номенклатура.Код,
	                      |	АК_Договор_СпецификацияТовары.Номенклатура.Артикул,
	                      |	АК_Договор_СпецификацияТовары.Номенклатура.Описание,
	                      |	АК_Договор_СпецификацияТовары.Количество,
	                      |	АК_Договор_СпецификацияТовары.Цена,
	                      |	АК_Договор_СпецификацияТовары.Сумма,
	                      |	АК_Договор_СпецификацияТовары.СтавкаНДС
	                      |ИЗ
	                      |	Документ.АК_Договор_Спецификация.Товары КАК АК_Договор_СпецификацияТовары
	                      |ГДЕ
	                      |	АК_Договор_СпецификацияТовары.Ссылка = &Ссылка
	                      |	И АК_Договор_СпецификацияТовары.Активность = ИСТИНА");
	
	Запрос.УстановитьПараметр("Ссылка",СсылкаНаОбъект);      
	Выборка = Запрос.Выполнить().Выбрать();
	ТабличныйДокумент = Новый ТабличныйДокумент;
	Макет = УправлениеПечатью.ПолучитьМакет("Документ.АК_Договор_Спецификация.АК_Спецификация");
	ОбластьМакета = Макет.ПолучитьОбласть("Заголовок");
    ОбластьМакета.Параметры.Номер =Номер;
	ОбластьМакета.Параметры.ПолнНаименованиеКонтрагента =ПолнНаименованиеКонтрагента;
	ОбластьМакета.Параметры.Дата =Дата;
    ТабличныйДокумент.Вывести(ОбластьМакета);

	ОбластьМакета = Макет.ПолучитьОбласть("Шапка");
	ТабличныйДокумент.Вывести(ОбластьМакета);
	
	НомерСТроки=0;
   	Пока Выборка.Следующий() Цикл
		НомерСтроки=НомерСтроки+1;
		ОбластьМакета = Макет.ПолучитьОбласть("Строка");
        ОбластьМакета.Параметры.Номенклатура =Выборка.Номенклатура;
		ОбластьМакета.Параметры.НомерСтроки =НомерСтроки;
        ОбластьМакета.Параметры.Код =Выборка.НоменклатураКод;
		ОбластьМакета.Параметры.Артикул =Выборка.НоменклатураАртикул;
        ОбластьМакета.Параметры.Количество =Выборка.Количество;
        ОбластьМакета.Параметры.Описание =Выборка.НоменклатураОписание;
        ОбластьМакета.Параметры.Цена =Выборка.Цена;
        ОбластьМакета.Параметры.Сумма =Выборка.Сумма;
        ОбластьМакета.Параметры.СтавкаНДС =Выборка.СтавкаНДС;
        ТабличныйДокумент.Вывести(ОбластьМакета);
	КонецЦикла;	
	
   	ТЗСумма=Запрос.Выполнить().Выгрузить();
   	ОбластьМакета = Макет.ПолучитьОбласть("Итого");
   	ОбластьМакета.Параметры.ВсегоКоличество = ТЗСумма.Итог("Количество");
   	ОбластьМакета.Параметры.ВсегоСумма = ТЗСумма.Итог("Сумма");
    ТабличныйДокумент.Вывести(ОбластьМакета);

	ОбластьМакета = Макет.ПолучитьОбласть("Подвал");
    ОбластьМакета.Параметры.СуммаПрописью =ФормированиеПечатныхФорм.СформироватьСуммуПрописью(ТЗСумма.Итог("Сумма"), ВалютаУпр);
	ОбластьМакета.Параметры.ФизЛицоНадпись =ФизЛицоНадпись;
    ОбластьМакета.Параметры.ДолжностьФизЛицо =ДолжностьФизЛицо;

   	ТабличныйДокумент.Вывести(ОбластьМакета);
	ТабличныйДокумент.АвтоМасштаб = Истина;
	
	Если ПривилегированныйРежим() Тогда
	    УстановитьПривилегированныйРежим(Ложь);	
	КонецЕсли;
	ТабличныйДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
	Возврат ТабличныйДокумент;
	КонецЦикла;
КонецФункции // 

Функция СформироватьПечатнуюФормуЗаявка(МассивОбъектов, ОбъектыПечати)
	Для Каждого СсылкаНаОбъект Из МассивОбъектов Цикл

	УстановитьПривилегированныйРежим(Истина);

	ТабличныйДокумент = Новый ТабличныйДокумент;
	ТабличныйДокумент.КоличествоЭкземпляров=1;
	
	ВалютаУпр = ЗначениеНастроекПовтИсп.ПолучитьЗначениеКонстанты("ВалютаУправленческогоУчета");
	Если ЗначениеЗаполнено(СсылкаНаОбъект.ДокументОснование) Тогда
		Номер = СсылкаНаОбъект.ДокументОснование.Номер;
        Дата=Формат(СсылкаНаОбъект.ДокументОснование.Дата,"ДЛФ=ДД");
		ПолнНаименованиеКонтрагента=СсылкаНаОбъект.ДокументОснование.Контрагент;
		ФизЛицоНадпись=СократитьФИО(СсылкаНаОбъект.ДокументОснование.ФизЛицо.Наименование);
		ДолжностьФизЛицо =СсылкаНаОбъект.ДокументОснование.ФизЛицо.АК_Должность.Наименование; 
	Иначе
		Сообщить("Не выбран документ основание");
		Номер="";
		Дата="";
        ПолнНаименованиеКонтрагента="";
		ФизЛицоНадпись="";
		ДолжностьФизЛицо ="";
 	КонецЕсли;	
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	АК_Договор_СпецификацияТовары.НомерСтроки,
	                      |	АК_Договор_СпецификацияТовары.Номенклатура,
						  |	АК_Договор_СпецификацияТовары.Ссылка,
	                      |	АК_Договор_СпецификацияТовары.Номенклатура.Код,
	                      |	АК_Договор_СпецификацияТовары.Номенклатура.Артикул,
	                      |	АК_Договор_СпецификацияТовары.Номенклатура.Описание,
	                      |	АК_Договор_СпецификацияТовары.Количество,
	                      |	АК_Договор_СпецификацияТовары.Цена,
	                      |	АК_Договор_СпецификацияТовары.Сумма,
	                      |	АК_Договор_СпецификацияТовары.СтавкаНДС
	                      |ИЗ
	                      |	Документ.АК_Договор_Спецификация.Товары КАК АК_Договор_СпецификацияТовары
	                      |ГДЕ
	                      |	АК_Договор_СпецификацияТовары.Ссылка = &Ссылка
	                      |	И АК_Договор_СпецификацияТовары.Активность = ИСТИНА");
	
	Запрос.УстановитьПараметр("Ссылка",СсылкаНаОбъект);      
	Выборка = Запрос.Выполнить().Выбрать();
	ТабличныйДокумент = Новый ТабличныйДокумент;
	Макет = УправлениеПечатью.ПолучитьМакет("Документ.АК_Договор_Спецификация.АК_ЗаявкаНаМонтаж");
	ОбластьМакета = Макет.ПолучитьОбласть("Заголовок");
    ОбластьМакета.Параметры.Номер =Номер;
	//ОбластьМакета.Параметры.ПолнНаименованиеКонтрагента =ПолнНаименованиеКонтрагента;
	ОбластьМакета.Параметры.Дата =Дата;
    ТабличныйДокумент.Вывести(ОбластьМакета);

	ОбластьМакета = Макет.ПолучитьОбласть("Шапка");
	ТабличныйДокумент.Вывести(ОбластьМакета);
	
	НомерСТроки=0;
   	Пока Выборка.Следующий() Цикл
		НомерСтроки=НомерСтроки+1;
		ОбластьМакета = Макет.ПолучитьОбласть("Строка");
        ОбластьМакета.Параметры.Номенклатура =Выборка.Номенклатура;
		ОбластьМакета.Параметры.НомерСтроки =НомерСтроки;
        ОбластьМакета.Параметры.Количество =Выборка.Количество;
        ОбластьМакета.Параметры.ЕдИзмерения =Выборка.Номенклатура.ЕдиницаИзмерения;
       	ТабличныйДокумент.Вывести(ОбластьМакета);
	КонецЦикла;	
	
   	ТЗСумма=Запрос.Выполнить().Выгрузить();
   	ОбластьМакета = Макет.ПолучитьОбласть("Итого");
   	ОбластьМакета.Параметры.ВсегоКоличество = ТЗСумма.Итог("Количество");
   	ТабличныйДокумент.Вывести(ОбластьМакета);

	ОбластьМакета = Макет.ПолучитьОбласть("Подвал");
    //ОбластьМакета.Параметры.СуммаПрописью =ФормированиеПечатныхФорм.СформироватьСуммуПрописью(ТЗСумма.Итог("Сумма"), ВалютаУпр);
	ОбластьМакета.Параметры.ФизЛицоНадпись =ФизЛицоНадпись;
	ОбластьМакета.Параметры.ДолжностьФизЛицо = ДолжностьФизЛицо;
    ОбластьМакета.Параметры.СтрокаАдресаСборки =СсылкаНаОбъект.СтрокаАдресаСборки;

   	ТабличныйДокумент.Вывести(ОбластьМакета);
	ТабличныйДокумент.АвтоМасштаб = Истина;
	
	Если ПривилегированныйРежим() Тогда
	    УстановитьПривилегированныйРежим(Ложь);	
	КонецЕсли;
	Возврат ТабличныйДокумент;
	КонецЦикла;
КонецФункции // 
Функция  СократитьФИО(Знач z1)
	z1=z1+" ";
	ФИО=Лев(z1,Найти(z1," ")-1);
	z1= Сред(z1,Найти(z1," ")+1);
	Пока Найти(z1," ") Цикл
         ФИО=ФИО+ " "+ВРег(Лев(z1,1))+".";
		 z1=Сред(z1,Найти(z1," ")+1);
	 КонецЦикла;
	 возврат ФИО;

КонецФункции